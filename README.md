# Phlogiston

## Purpose
Generate burnup, cycle time, and other charts from Phabricator.  Intended for experimental prototyping and proof of concept for similar functionality to built into Phabricator.  Also a platform to do complex scripted data handling for Phab projects prior to reporting.  works from data at at http://dumps.wikimedia.org/other/misc/phabricator_public.dump, generated by https://gerrit.wikimedia.org/r/#/c/214398/2/wmfphablib/phabdb.py

## Function
1. --load
 * reads a JSON file produced by phabricator dump.
 * loads a postgresql database containing the data
2. --reconstruct
 * Reconstructs the historical state of all tasks in the specified projects project day by day
3. --report
 * Generates CSV files for all reports
 * Uses R to graph the data as PNG files

## TODOs
 * status fields are all double-quote-delimited in the database, which makes the SQL confusing
 * softcode the rest of the file and database locations (what is best practice?)
 * refactor the .R and .SQL to obey DRY; currently copy-pasted from VE example
 * optimize so the whole thing doesn't take 2+ hours for VE

## Typical usage:
```
wget http://dumps.wikimedia.org/other/misc/phabricator_public.dump
cd phlogiston
python3 phlogiston.py --load --reconstruct --report --project ve_source.py
```

## Environment:
```
~phlogiston/                       <- dump goes here
~phlogiston/phlogiston/            <- program goes here
~phlogiston/html                   <- html index and reports go here
~/tmp/                             <- PNG output goes here
Postgresql database named "phab"   <- data goes here
```

## Installation Notes:

1. Get an account and shell access on WMF Labs with Ubuntu 14.04 host
2. Install prerequisites on the system.  As root:
  1. Create a Phlogiston user.  `adduser phlogiston`
  2. Download Phlogiston:
   * `su - phlogiston`
   * `git clone https://github.com/wikimedia/phlogiston`
   * `exit`
  1. Follow instructions to add Postgresql backport to get 9.4: http://www.postgresql.org/download/linux/ubuntu/
  2. Get access to newer R
     * `echo deb http://cran.es.r-project.org/bin/linux/ubuntu trusty/ > /etc/apt/sources.list.d/r.list`
     * `gpg --keyserver keyserver.ubuntu.com --recv-key E084DAB9`
     * `gpg -a --export E084DAB9 | sudo apt-key add - `
     * `apt-get update`
  3. Install ubuntu packages
     * `apt-get install nginx postgresql-9.4 python3-pip python3-psycopg2 python3-dev postgresql-contrib r-base r-base-dev`
  4. Install R packages.
     * `R`
     * `install.packages(c("ggplot2", "ggthemes", "argparse", "reshape"))`
     * `quit()`
  5. Set up Nginx website
     * `cp ~phlogiston/site-phlogiston /etc/nginx/sites-available`
     * `rm /etc/nginx/sites-enabled/default`
     * `ln -s /etc/nginx/sites-available/site-phlogiston /etc/nginx/sites-enabled`
     * `service nginx restart`
  6. Change permissions so that the postgres user can share files with phlogiston
     * `usermod -a -G phlogiston postgres`
     * restart postgres so that this takes effect
3. Set up database.
   1. As user postgres,
     * `createuser -s phlogiston`
     * `createdb -O phlogiston phab`
4. Install virtualenv and packages.  As phlogiston, 
     * `mkdir ~/html`
     * `cp ~/phlogiston/html/index.html ~/html`
     * `cp ~/phlogiston/html/caution.html ~/html`
     * `pip3 install virtualenv pyscopg2 pytz`
5. Set up the script to run via cron
   * `crontab -e`
   * put `0   4    *   *   *   bash ~/phlogiston/batch_report.bash` at the end of the crontab and save and exit
   * wait until tomorrow


